"use strict";var u=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var v=Object.prototype.hasOwnProperty;var y=(e,t)=>{for(var r in t)u(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of A(t))!v.call(e,s)&&s!==r&&u(e,s,{get:()=>t[s],enumerable:!(a=T(t,s))||a.enumerable});return e};var $=e=>I(u({},"__esModule",{value:!0}),e);var O={};y(O,{handler:()=>b});module.exports=$(O);var i=require("@aws-sdk/client-rds"),o=require("@aws-sdk/client-elasticache"),c=require("@aws-sdk/client-ecs"),l=require("@aws-sdk/client-lambda"),E=require("@aws-sdk/client-dynamodb"),d=require("@aws-sdk/lib-dynamodb"),n=require("@aws-sdk/client-ssm"),g=new i.RDSClient({}),m=new o.ElastiCacheClient({}),p=new c.ECSClient({}),P=new l.LambdaClient({}),R=d.DynamoDBDocumentClient.from(new E.DynamoDBClient({})),w=new n.SSMClient({});async function S(e,t){console.log(`Stopping RDS cluster: ${t}`);let a=(await g.send(new i.DescribeDBClustersCommand({DBClusterIdentifier:t}))).DBClusters?.[0]?.Status;if(a==="stopped"){console.log("RDS cluster already stopped");return}if(a!=="available")throw new Error(`Cannot stop RDS cluster in status: ${a}`);await g.send(new i.StopDBClusterCommand({DBClusterIdentifier:t})),await w.send(new n.PutParameterCommand({Name:`/garmaxai/idle-state/${e}/rds-cluster`,Value:t,Type:"String",Overwrite:!0})),await C(`RDS_CLUSTER#${e}`,e,"STOPPING",{clusterId:t,stoppedAt:new Date().toISOString()}),console.log(`RDS cluster stop initiated: ${t}`)}async function h(e,t){console.log(`Tearing down ElastiCache cluster: ${t}`);let r=await m.send(new o.DescribeCacheClustersCommand({CacheClusterId:t})).catch(()=>null);if(!r||!r.CacheClusters||r.CacheClusters.length===0){console.log("ElastiCache cluster not found, skipping");return}let a=r.CacheClusters[0].CacheClusterStatus;if(a!=="available"){console.log(`ElastiCache cluster not available (status: ${a}), skipping`);return}if(e==="PROD"){let s=`garmaxai-redis-${e}-idle-${Date.now()}`;console.log(`Creating snapshot: ${s}`),await m.send(new o.CreateSnapshotCommand({CacheClusterId:t,SnapshotName:s})),await w.send(new n.PutParameterCommand({Name:`/garmaxai/idle-state/${e}/redis-snapshot`,Value:s,Type:"String",Overwrite:!0})),await new Promise(N=>setTimeout(N,5e3))}await m.send(new o.DeleteCacheClusterCommand({CacheClusterId:t})),await C(`ELASTICACHE#${e}`,e,"DELETING",{clusterId:t,deletedAt:new Date().toISOString(),snapshotCreated:e==="PROD"}),console.log(`ElastiCache cluster deletion initiated: ${t}`)}async function f(e,t){console.log(`Scaling down ECS services in cluster: ${t}`);let r=await p.send(new c.ListServicesCommand({cluster:t}));if(!r.serviceArns||r.serviceArns.length===0){console.log("No ECS services found in cluster");return}await w.send(new n.PutParameterCommand({Name:`/garmaxai/idle-state/${e}/ecs-services`,Value:r.serviceArns.join(","),Type:"StringList",Overwrite:!0}));for(let a of r.serviceArns){let s=a.split("/").pop();console.log(`Scaling service to 0: ${s}`),await p.send(new c.UpdateServiceCommand({cluster:t,service:s,desiredCount:0}))}await C(`ECS_CLUSTER#${e}`,e,"SCALED_DOWN",{cluster:t,serviceCount:r.serviceArns.length,scaledDownAt:new Date().toISOString()}),console.log(`Scaled down ${r.serviceArns.length} ECS services`)}async function D(e,t){console.log(`Invoking NAT Gateway manager for VPC: ${t}`);let r=process.env.NAT_MANAGER_FUNCTION_NAME||`GarmaxAi-NATManager-${e}`,a=await P.send(new l.InvokeCommand({FunctionName:r,Payload:JSON.stringify({action:"teardown",vpcId:t})})),s=JSON.parse(new TextDecoder().decode(a.Payload));if(console.log("NAT Gateway manager response:",s),s.statusCode!==200)throw new Error(`NAT Gateway teardown failed: ${s.error}`);console.log("NAT Gateway teardown completed")}async function C(e,t,r,a){let s=process.env.STATE_TABLE_NAME||"GarmaxAi-ResourceState";await R.send(new d.PutCommand({TableName:s,Item:{resourceKey:e,timestamp:Date.now(),stage:t,currentState:r,metadata:a,ttl:Math.floor(Date.now()/1e3)+2160*60*60}}))}var b=async e=>{console.log("Teardown orchestrator invoked:",JSON.stringify(e,null,2));try{let{resource:t,stage:r}=e;switch(await w.send(new n.PutParameterCommand({Name:`/garmaxai/idle-state/${r}/timestamp`,Value:new Date().toISOString(),Type:"String",Overwrite:!0})),t){case"rds":if(!e.clusterId)throw new Error("clusterId required for RDS teardown");await S(r,e.clusterId);break;case"elasticache":if(!e.redisClusterId)throw new Error("redisClusterId required for ElastiCache teardown");await h(r,e.redisClusterId);break;case"ecs":if(!e.ecsCluster)throw new Error("ecsCluster required for ECS teardown");await f(r,e.ecsCluster);break;case"nat-gateway":if(!e.vpcId)throw new Error("vpcId required for NAT Gateway teardown");await D(r,e.vpcId);break;case"all":await Promise.all([e.clusterId?S(r,e.clusterId):Promise.resolve(),e.redisClusterId?h(r,e.redisClusterId):Promise.resolve(),e.ecsCluster?f(r,e.ecsCluster):Promise.resolve(),e.vpcId?D(r,e.vpcId):Promise.resolve()]);break;default:throw new Error(`Unknown resource: ${t}`)}return{statusCode:200,message:`Teardown completed for ${t} in ${r}`,timestamp:new Date().toISOString()}}catch(t){throw console.error("Teardown orchestrator error:",t),t}};0&&(module.exports={handler});
//# sourceMappingURL=index.js.map
